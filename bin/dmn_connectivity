#!/usr/bin/env python3

import argparse
import glob
import os
import numpy as np
import pandas as pd
from nilearn.connectome import ConnectivityMeasure

def main():
	parser = argparse.ArgumentParser(
		description="Compute intra-DMN connectivity metrics (Pearson + Fisher Z)"
	)

	parser.add_argument("--ts-dir", required=True, help="Directory with sub-XX folders containing the PCC, mPFC, IPL L and R .txt files.")
	parser.add_argument("--out", required=True, help="Output CSV file including PCC-mPFC, PCC-IPL_L, PCC-IPL_R, and mean intra DMN.")

	args = parser.parse_args()

	rows=[]

	for sub in sorted(glob.glob(os.path.join(args.ts_dir, "sub-*"))):
		sid = os.path.basename(sub)

		try:
			ts  = np.column_stack([
				np.loadtxt(f"{sub}/PCC.txt"),
				np.loadtxt(f"{sub}/mPFC.txt"),
				np.loadtxt(f"{sub}/IPL_L.txt"),
				np.loadtxt(f"{sub}/IPL_R.txt")
			])
		except Exception:
			print(f"[WARN] Missing files for {sid}")
			continue

		conn = ConnectivityMeasure(kind="correlation")
		corr = conn.fit_transform([ts])[0]
		print(corr)
		z_corr = np.arctanh(corr)

		rows.append({
			"subject": sid,
			# Pearson
			"PCC_mPFC_Pearson": corr[0,1],
			"PCC_IPL_L_Pearson": corr[0,2],
			"PCC_IPL_R_Pearson": corr[0,3],
			# Fisher Z
			"PCC_mPFC_FisherZ": z_corr[0,1],
			"PCC_IPL_L_FisherZ": z_corr[0,2],
			"PCC_IPL_R_FisherZ": z_corr[0,3],
			# AVG intra-DMN (Fisher Z)
			"mean_intra_DMN_Z": np.mean(z_corr[0,1:4]),
			# AVG converted to r (optional)
			"mean_intra_DMN_r": np.tanh(np.mean(z_corr[0,1:4]))
		})

	df = pd.DataFrame(rows)
	df.to_csv(args.out, index = False)

	print(f"[OK] Saved {len(df)} subjects to {args.out}")

if __name__ == "__main__":
	main()
 
