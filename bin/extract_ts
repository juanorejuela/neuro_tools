#!/usr/bin/env python3

import argparse
import os
import pandas as pd

from neuro_tools.timeseries import extract_roi_timeseries
from neuro_tools.rois import DMN_COORDS

def main():
	parser = argparse.ArgumentParser(
		description = "Extract ROI-based BOLD time series"
	)

	parser.add_argument("--bold", required=True, help="Preprocessed BOLD NIfTI")
	parser.add_argument("--confounds", required=True, help="Confounds TSV (fMRIPrep)")
	parser.add_argument("--network", default="DMN", choices=["DMN"], help="Network to extract")
	parser.add_argument("--out", required=True, help="Output directory")
	parser.add_argument("--tr", type=float, default=2.0)
	parser.add_argument("--radius", type=int, default=6)
	parser.add_argument("--no-zscore", action="store_true", help="Disable z-scoring")

	args = parser.parse_args()

	if args.network == "DMN":
		rois = DMN_COORDS
	else:
		raise ValueError("Network not implemented")

	os.makedirs(args.out, exist_ok=True)

	ts = extract_roi_timeseries(
		bold_img = args.bold,
		confounds_tsv = args.confounds,
		roi_coords = rois,
		radius = args.radius,
		tr = args.tr,
		standardize = not args.no_zscore
	)

	for roi, v in ts.items():
		pd.DataFrame(v).to_csv(
			f"{args.out}/{roi}.txt",
			index = False,
			header = False
		)
	
	print(f"[OK] Extracted {len(ts)} ROIs into {args.out}")

if __name__ == "__main__":
	main()
